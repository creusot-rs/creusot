module M_foo
  use creusot.int.Int32
  use creusot.prelude.MutBorrow
  use creusot.prelude.Any
  
  type t_PermCell_i32
  
  type t_Perm_PermCell_i32
  
  type tup2_PermCell_i32_Ghost_Box_Perm_PermCell_i32_Global = { f0: t_PermCell_i32; f1: t_Perm_PermCell_i32 }
  
  function ward_PermCell_i32 (self: t_Perm_PermCell_i32) : t_PermCell_i32
  
  function val_PermCell_i32 (self: t_Perm_PermCell_i32) : Int32.t
  
  function view_Perm_PermCell_i32 [@inline:trivial] (self: t_Perm_PermCell_i32) : Int32.t = val_PermCell_i32 self
  
  meta "rewrite_def" function view_Perm_PermCell_i32
  
  function view_Box_Perm_PermCell_i32_Global [@inline:trivial] (self: t_Perm_PermCell_i32) : Int32.t =
    view_Perm_PermCell_i32 self
  
  meta "rewrite_def" function view_Box_Perm_PermCell_i32_Global
  
  let rec new_i32 (value: Int32.t) (return (x: tup2_PermCell_i32_Ghost_Box_Perm_PermCell_i32_Global)) = any
    [ return (result: tup2_PermCell_i32_Ghost_Box_Perm_PermCell_i32_Global) -> {result.f0 = ward_PermCell_i32 result.f1}
      {view_Box_Perm_PermCell_i32_Global result.f1 = value}
      (! return {result}) ]
  
  let rec deref_Ghost_Box_Perm_PermCell_i32_Global (self: t_Perm_PermCell_i32) (return (x: t_Perm_PermCell_i32)) = any
    [ return (result: t_Perm_PermCell_i32) -> {result = self} (! return {result}) ]
  
  let rec new_ref_Perm_PermCell_i32 (x: t_Perm_PermCell_i32) (return (x'0: t_Perm_PermCell_i32)) = any
    [ return (result: t_Perm_PermCell_i32) -> {result = x} (! return {result}) ]
  
  let rec borrow_i32 (self: t_PermCell_i32) (perm: t_Perm_PermCell_i32) (return (x: Int32.t)) =
    {[@expl:borrow requires] self = ward_PermCell_i32 perm}
    any [ return (result: Int32.t) -> {result = view_Perm_PermCell_i32 perm} (! return {result}) ]
  
  let rec deref_mut_Ghost_Box_Perm_PermCell_i32_Global (self: MutBorrow.t t_Perm_PermCell_i32)
    (return (x: MutBorrow.t t_Perm_PermCell_i32)) = any
    [ return (result: MutBorrow.t t_Perm_PermCell_i32) -> {result = self} (! return {result}) ]
  
  predicate resolve_refmut_Box_Perm_PermCell_i32_Global [@inline:trivial] (_1: MutBorrow.t t_Perm_PermCell_i32) =
    _1.final = _1.current
  
  meta "rewrite_def" predicate resolve_refmut_Box_Perm_PermCell_i32_Global
  
  predicate resolve_refmut_Perm_PermCell_i32 [@inline:trivial] (_1: MutBorrow.t t_Perm_PermCell_i32) =
    _1.final = _1.current
  
  meta "rewrite_def" predicate resolve_refmut_Perm_PermCell_i32
  
  let rec new_refmut_Perm_PermCell_i32 (x: MutBorrow.t t_Perm_PermCell_i32)
    (return (x'0: MutBorrow.t t_Perm_PermCell_i32)) = any
    [ return (result: MutBorrow.t t_Perm_PermCell_i32) -> {result = x} (! return {result}) ]
  
  function fin_Ghost_refmut_Perm_PermCell_i32 [@inline:trivial] (self: MutBorrow.t t_Perm_PermCell_i32) : t_Perm_PermCell_i32
   = self.final
  
  meta "rewrite_def" function fin_Ghost_refmut_Perm_PermCell_i32
  
  let rec borrow_mut_i32 (self: t_PermCell_i32) (perm: MutBorrow.t t_Perm_PermCell_i32)
    (return (x: MutBorrow.t Int32.t)) = {[@expl:borrow_mut requires] self = ward_PermCell_i32 perm.current}
    any
    [ return (result: MutBorrow.t Int32.t) -> {self = ward_PermCell_i32 (fin_Ghost_refmut_Perm_PermCell_i32 perm)}
      {result.current = view_Perm_PermCell_i32 perm.current}
      {result.final = view_Perm_PermCell_i32 (fin_Ghost_refmut_Perm_PermCell_i32 perm)}
      (! return {result}) ]
  
  predicate resolve_refmut_i32 [@inline:trivial] (_1: MutBorrow.t Int32.t) = _1.final = _1.current
  
  meta "rewrite_def" predicate resolve_refmut_i32
  
  let rec replace_i32 (self: t_PermCell_i32) (perm: MutBorrow.t t_Perm_PermCell_i32) (val': Int32.t)
    (return (x: Int32.t)) = {[@expl:replace requires] self = ward_PermCell_i32 perm.current}
    any
    [ return (result: Int32.t) -> {val' = view_Perm_PermCell_i32 (fin_Ghost_refmut_Perm_PermCell_i32 perm)}
      {result = view_Perm_PermCell_i32 perm.current}
      {self = ward_PermCell_i32 (fin_Ghost_refmut_Perm_PermCell_i32 perm)}
      (! return {result}) ]
  
  let rec into_inner_i32 (self: t_PermCell_i32) (perm: t_Perm_PermCell_i32) (return (x: Int32.t)) =
    {[@expl:into_inner requires] self = ward_PermCell_i32 perm}
    any [ return (result: Int32.t) -> {result = view_Box_Perm_PermCell_i32_Global perm} (! return {result}) ]
  
  predicate resolve_ref_i32 [@inline:trivial] (_1: Int32.t) = true
  
  meta "rewrite_def" predicate resolve_ref_i32
  
  predicate resolve_Perm_PermCell_i32 [@inline:trivial] (self: t_Perm_PermCell_i32) =
    resolve_ref_i32 (val_PermCell_i32 self)
  
  meta "rewrite_def" predicate resolve_Perm_PermCell_i32
  
  predicate resolve_Perm_PermCell_i32'0 (_1: t_Perm_PermCell_i32)
  
  axiom resolve_axiom: forall x: t_Perm_PermCell_i32 [resolve_Perm_PermCell_i32'0 x]. resolve_Perm_PermCell_i32'0 x
      -> resolve_Perm_PermCell_i32 x
  
  predicate resolve_Box_Perm_PermCell_i32_Global [@inline:trivial] (_1: t_Perm_PermCell_i32) =
    resolve_Perm_PermCell_i32'0 _1
  
  meta "rewrite_def" predicate resolve_Box_Perm_PermCell_i32_Global
  
  predicate resolve_Ghost_Box_Perm_PermCell_i32_Global [@inline:trivial] (_1: t_Perm_PermCell_i32) =
    resolve_Box_Perm_PermCell_i32_Global _1
  
  meta "rewrite_def" predicate resolve_Ghost_Box_Perm_PermCell_i32_Global
  
  predicate resolve_PermCell_i32 (_1: t_PermCell_i32)
  
  meta "compute_max_steps" 1000000
  
  meta "select_lsinst" "all"
  
  let rec foo (return (x: Int32.t)) = (! bb0
    [ bb0 = s0
      [ s0 = new_i32 {(1: Int32.t)} (fun (_x: tup2_PermCell_i32_Ghost_Box_Perm_PermCell_i32_Global) -> [ &_4 <- _x ] s1)
      | s1 = [ &p <- _4.f0 ] s2
      | s2 = [ &own <- _4.f1 ] s3
      | s3 = deref_Ghost_Box_Perm_PermCell_i32_Global {own} (fun (_x: t_Perm_PermCell_i32) -> [ &_13 <- _x ] s4)
      | s4 = [ &_12 <- _13 ] s5
      | s5 = new_ref_Perm_PermCell_i32 {_12} (fun (_x: t_Perm_PermCell_i32) -> [ &_10 <- _x ] s6)
      | s6 = borrow_i32 {p} {_10} (fun (_x: Int32.t) -> [ &_8 <- _x ] s7)
      | s7 = [ &_6 <- _8 = (1: Int32.t) ] s8
      | s8 = any [ br0 -> {_6 = false} (! bb6) | br1 -> {_6} (! bb5) ] ]
    | bb5 = s0
      [ s0 = MutBorrow.borrow_mut <t_Perm_PermCell_i32> {own}
          (fun (_bor: MutBorrow.t t_Perm_PermCell_i32) -> [ &_25 <- _bor ] [ &own <- _bor.final ] s1)
      | s1 = deref_mut_Ghost_Box_Perm_PermCell_i32_Global {_25}
          (fun (_x: MutBorrow.t t_Perm_PermCell_i32) -> [ &_24 <- _x ] s2)
      | s2 = MutBorrow.borrow_final <t_Perm_PermCell_i32> {_24.current} {MutBorrow.get_id _24}
          (fun (_bor: MutBorrow.t t_Perm_PermCell_i32) ->
            [ &_23 <- _bor ] [ &_24 <- { _24 with current = _bor.final } ] s3)
      | s3 = MutBorrow.borrow_final <t_Perm_PermCell_i32> {_23.current} {MutBorrow.get_id _23}
          (fun (_bor: MutBorrow.t t_Perm_PermCell_i32) ->
            [ &_22 <- _bor ] [ &_23 <- { _23 with current = _bor.final } ] s4)
      | s4 = -{resolve_refmut_Box_Perm_PermCell_i32_Global _24}- s5
      | s5 = -{resolve_refmut_Perm_PermCell_i32 _23}- s6
      | s6 = MutBorrow.borrow_final <t_Perm_PermCell_i32> {_22.current} {MutBorrow.get_id _22}
          (fun (_bor: MutBorrow.t t_Perm_PermCell_i32) ->
            [ &_21 <- _bor ] [ &_22 <- { _22 with current = _bor.final } ] s7)
      | s7 = -{resolve_refmut_Perm_PermCell_i32 _22}- s8
      | s8 = MutBorrow.borrow_final <t_Perm_PermCell_i32> {_21.current} {MutBorrow.get_id _21}
          (fun (_bor: MutBorrow.t t_Perm_PermCell_i32) ->
            [ &_20 <- _bor ] [ &_21 <- { _21 with current = _bor.final } ] s9)
      | s9 = new_refmut_Perm_PermCell_i32 {_20} (fun (_x: MutBorrow.t t_Perm_PermCell_i32) -> [ &_19 <- _x ] s10)
      | s10 = -{resolve_refmut_Perm_PermCell_i32 _21}- s11
      | s11 = borrow_mut_i32 {p} {_19} (fun (_x: MutBorrow.t Int32.t) -> [ &_17 <- _x ] s12)
      | s12 = [ &_17 <- { _17 with current = (2: Int32.t) } ] s13
      | s13 = -{resolve_refmut_i32 _17}- s14
      | s14 = deref_Ghost_Box_Perm_PermCell_i32_Global {own} (fun (_x: t_Perm_PermCell_i32) -> [ &_34 <- _x ] s15)
      | s15 = [ &_33 <- _34 ] s16
      | s16 = new_ref_Perm_PermCell_i32 {_33} (fun (_x: t_Perm_PermCell_i32) -> [ &_31 <- _x ] s17)
      | s17 = borrow_i32 {p} {_31} (fun (_x: Int32.t) -> [ &_29 <- _x ] s18)
      | s18 = [ &_27 <- _29 = (2: Int32.t) ] s19
      | s19 = any [ br0 -> {_27 = false} (! bb14) | br1 -> {_27} (! bb13) ] ]
    | bb13 = s0
      [ s0 = MutBorrow.borrow_mut <t_Perm_PermCell_i32> {own}
          (fun (_bor: MutBorrow.t t_Perm_PermCell_i32) -> [ &_47 <- _bor ] [ &own <- _bor.final ] s1)
      | s1 = deref_mut_Ghost_Box_Perm_PermCell_i32_Global {_47}
          (fun (_x: MutBorrow.t t_Perm_PermCell_i32) -> [ &_46 <- _x ] s2)
      | s2 = MutBorrow.borrow_final <t_Perm_PermCell_i32> {_46.current} {MutBorrow.get_id _46}
          (fun (_bor: MutBorrow.t t_Perm_PermCell_i32) ->
            [ &_45 <- _bor ] [ &_46 <- { _46 with current = _bor.final } ] s3)
      | s3 = MutBorrow.borrow_final <t_Perm_PermCell_i32> {_45.current} {MutBorrow.get_id _45}
          (fun (_bor: MutBorrow.t t_Perm_PermCell_i32) ->
            [ &_44 <- _bor ] [ &_45 <- { _45 with current = _bor.final } ] s4)
      | s4 = -{resolve_refmut_Box_Perm_PermCell_i32_Global _46}- s5
      | s5 = -{resolve_refmut_Perm_PermCell_i32 _45}- s6
      | s6 = MutBorrow.borrow_final <t_Perm_PermCell_i32> {_44.current} {MutBorrow.get_id _44}
          (fun (_bor: MutBorrow.t t_Perm_PermCell_i32) ->
            [ &_43 <- _bor ] [ &_44 <- { _44 with current = _bor.final } ] s7)
      | s7 = -{resolve_refmut_Perm_PermCell_i32 _44}- s8
      | s8 = MutBorrow.borrow_final <t_Perm_PermCell_i32> {_43.current} {MutBorrow.get_id _43}
          (fun (_bor: MutBorrow.t t_Perm_PermCell_i32) ->
            [ &_42 <- _bor ] [ &_43 <- { _43 with current = _bor.final } ] s9)
      | s9 = new_refmut_Perm_PermCell_i32 {_42} (fun (_x: MutBorrow.t t_Perm_PermCell_i32) -> [ &_41 <- _x ] s10)
      | s10 = -{resolve_refmut_Perm_PermCell_i32 _43}- s11
      | s11 = replace_i32 {p} {_41} {(3: Int32.t)} (fun (_x: Int32.t) -> [ &_39 <- _x ] s12)
      | s12 = [ &_38 <- _39 = (2: Int32.t) ] s13
      | s13 = any [ br0 -> {_38 = false} (! bb19) | br1 -> {_38} (! bb18) ] ]
    | bb18 = s0 [ s0 = into_inner_i32 {p} {own} (fun (_x: Int32.t) -> [ &_ret <- _x ] s1) | s1 = return {_ret} ]
    | bb19 = s0
      [ s0 = -{resolve_Ghost_Box_Perm_PermCell_i32_Global own}- s1
      | s1 = -{resolve_PermCell_i32 p}- s2
      | s2 = {false} any ]
    | bb14 = s0
      [ s0 = -{resolve_Ghost_Box_Perm_PermCell_i32_Global own}- s1
      | s1 = -{resolve_PermCell_i32 p}- s2
      | s2 = {false} any ]
    | bb6 = s0
      [ s0 = -{resolve_Ghost_Box_Perm_PermCell_i32_Global own}- s1
      | s1 = -{resolve_PermCell_i32 p}- s2
      | s2 = {false} any ] ]
    [ & _ret: Int32.t = Any.any_l ()
    | & p: t_PermCell_i32 = Any.any_l ()
    | & own: t_Perm_PermCell_i32 = Any.any_l ()
    | & _4: tup2_PermCell_i32_Ghost_Box_Perm_PermCell_i32_Global = Any.any_l ()
    | & _6: bool = Any.any_l ()
    | & _8: Int32.t = Any.any_l ()
    | & _10: t_Perm_PermCell_i32 = Any.any_l ()
    | & _12: t_Perm_PermCell_i32 = Any.any_l ()
    | & _13: t_Perm_PermCell_i32 = Any.any_l ()
    | & _17: MutBorrow.t Int32.t = Any.any_l ()
    | & _19: MutBorrow.t t_Perm_PermCell_i32 = Any.any_l ()
    | & _20: MutBorrow.t t_Perm_PermCell_i32 = Any.any_l ()
    | & _21: MutBorrow.t t_Perm_PermCell_i32 = Any.any_l ()
    | & _22: MutBorrow.t t_Perm_PermCell_i32 = Any.any_l ()
    | & _23: MutBorrow.t t_Perm_PermCell_i32 = Any.any_l ()
    | & _24: MutBorrow.t t_Perm_PermCell_i32 = Any.any_l ()
    | & _25: MutBorrow.t t_Perm_PermCell_i32 = Any.any_l ()
    | & _27: bool = Any.any_l ()
    | & _29: Int32.t = Any.any_l ()
    | & _31: t_Perm_PermCell_i32 = Any.any_l ()
    | & _33: t_Perm_PermCell_i32 = Any.any_l ()
    | & _34: t_Perm_PermCell_i32 = Any.any_l ()
    | & _38: bool = Any.any_l ()
    | & _39: Int32.t = Any.any_l ()
    | & _41: MutBorrow.t t_Perm_PermCell_i32 = Any.any_l ()
    | & _42: MutBorrow.t t_Perm_PermCell_i32 = Any.any_l ()
    | & _43: MutBorrow.t t_Perm_PermCell_i32 = Any.any_l ()
    | & _44: MutBorrow.t t_Perm_PermCell_i32 = Any.any_l ()
    | & _45: MutBorrow.t t_Perm_PermCell_i32 = Any.any_l ()
    | & _46: MutBorrow.t t_Perm_PermCell_i32 = Any.any_l ()
    | & _47: MutBorrow.t t_Perm_PermCell_i32 = Any.any_l () ])
    [ return (result: Int32.t) -> {[@expl:foo ensures] Int32.to_int result = 3} (! return {result}) ]
end
