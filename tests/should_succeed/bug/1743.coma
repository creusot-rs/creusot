module M_impl_S__minimize (* S *)
  use creusot.prelude.MutBorrow
  use creusot.prelude.Opaque
  use creusot.prelude.Ptr
  use creusot.int.UInt64
  use creusot.int.Int32
  use creusot.prelude.Any
  use int.Int
  
  type t_Perm_ptr_i32
  
  type t_S = { perm: t_Perm_ptr_i32; ptr: Opaque.ptr }
  
  predicate is_null_ptr_i32 (self: Opaque.ptr) = Ptr.addr_logic_u64 self = (0: UInt64.t)
  
  function ward_ptr_i32 (self: t_Perm_ptr_i32) : Opaque.ptr
  
  predicate metadata_matches_i32 [@inline:trivial] (_value: Int32.t) (_metadata: ()) = true
  
  meta "rewrite_def" predicate metadata_matches_i32
  
  function val_ptr_i32 (self: t_Perm_ptr_i32) : Int32.t
  
  function metadata_i32 (_1: Opaque.ptr) : ()
  
  predicate inv_ref_i32 [@inline:trivial] (_1: Int32.t) = true
  
  meta "rewrite_def" predicate inv_ref_i32
  
  predicate invariant_Perm_ptr_i32 (self: t_Perm_ptr_i32) =
    not is_null_ptr_i32 (ward_ptr_i32 self)
    /\ metadata_matches_i32 (val_ptr_i32 self) (metadata_i32 (ward_ptr_i32 self)) /\ inv_ref_i32 (val_ptr_i32 self)
  
  predicate inv_Perm_ptr_i32 (_1: t_Perm_ptr_i32)
  
  axiom inv_axiom [@rewrite]: forall x: t_Perm_ptr_i32 [inv_Perm_ptr_i32 x]. inv_Perm_ptr_i32 x
      = invariant_Perm_ptr_i32 x
  
  predicate invariant_Box_Perm_ptr_i32_Global (self: t_Perm_ptr_i32) = inv_Perm_ptr_i32 self
  
  predicate inv_Box_Perm_ptr_i32_Global [@inline:trivial] (_1: t_Perm_ptr_i32) = invariant_Box_Perm_ptr_i32_Global _1
  
  meta "rewrite_def" predicate inv_Box_Perm_ptr_i32_Global
  
  predicate invariant_Ghost_Box_Perm_ptr_i32_Global [@inline:trivial] (self: t_Perm_ptr_i32) =
    inv_Box_Perm_ptr_i32_Global self
  
  meta "rewrite_def" predicate invariant_Ghost_Box_Perm_ptr_i32_Global
  
  predicate inv_Ghost_Box_Perm_ptr_i32_Global [@inline:trivial] (_1: t_Perm_ptr_i32) =
    invariant_Ghost_Box_Perm_ptr_i32_Global _1
  
  meta "rewrite_def" predicate inv_Ghost_Box_Perm_ptr_i32_Global
  
  predicate inv_S (_1: t_S)
  
  axiom inv_axiom'0 [@rewrite]: forall x: t_S [inv_S x]. inv_S x = inv_Ghost_Box_Perm_ptr_i32_Global x.perm
  
  predicate invariant_refmut_S [@inline:trivial] (self: MutBorrow.t t_S) = inv_S self.current /\ inv_S self.final
  
  meta "rewrite_def" predicate invariant_refmut_S
  
  predicate inv_refmut_S [@inline:trivial] (_1: MutBorrow.t t_S) = invariant_refmut_S _1
  
  meta "rewrite_def" predicate inv_refmut_S
  
  predicate resolve_refmut_S [@inline:trivial] (_1: MutBorrow.t t_S) = _1.final = _1.current
  
  meta "rewrite_def" predicate resolve_refmut_S
  
  predicate invariant_ref_Ghost_Box_Perm_ptr_i32_Global [@inline:trivial] (self: t_Perm_ptr_i32) =
    inv_Ghost_Box_Perm_ptr_i32_Global self
  
  meta "rewrite_def" predicate invariant_ref_Ghost_Box_Perm_ptr_i32_Global
  
  predicate inv_ref_Ghost_Box_Perm_ptr_i32_Global [@inline:trivial] (_1: t_Perm_ptr_i32) =
    invariant_ref_Ghost_Box_Perm_ptr_i32_Global _1
  
  meta "rewrite_def" predicate inv_ref_Ghost_Box_Perm_ptr_i32_Global
  
  predicate invariant_ref_Box_Perm_ptr_i32_Global [@inline:trivial] (self: t_Perm_ptr_i32) =
    inv_Box_Perm_ptr_i32_Global self
  
  meta "rewrite_def" predicate invariant_ref_Box_Perm_ptr_i32_Global
  
  predicate inv_ref_Box_Perm_ptr_i32_Global [@inline:trivial] (_1: t_Perm_ptr_i32) =
    invariant_ref_Box_Perm_ptr_i32_Global _1
  
  meta "rewrite_def" predicate inv_ref_Box_Perm_ptr_i32_Global
  
  let rec deref_Ghost_Box_Perm_ptr_i32_Global (self: t_Perm_ptr_i32) (return (x: t_Perm_ptr_i32)) =
    {[@stop_split] [@expl:deref 'self' type invariant] inv_ref_Ghost_Box_Perm_ptr_i32_Global self}
    any
    [ return (result: t_Perm_ptr_i32) ->
    {[@stop_split] [@expl:deref_Ghost_Box_Perm_ptr_i32_Global ensures] ([@stop_split] [@expl:deref result type invariant] inv_ref_Box_Perm_ptr_i32_Global result)
      /\ ([@stop_split] [@expl:deref ensures] result = self)}
      (! return {result}) ]
  
  predicate invariant_ref_Perm_ptr_i32 [@inline:trivial] (self: t_Perm_ptr_i32) = inv_Perm_ptr_i32 self
  
  meta "rewrite_def" predicate invariant_ref_Perm_ptr_i32
  
  predicate inv_ref_Perm_ptr_i32 [@inline:trivial] (_1: t_Perm_ptr_i32) = invariant_ref_Perm_ptr_i32 _1
  
  meta "rewrite_def" predicate inv_ref_Perm_ptr_i32
  
  predicate invariant_Ghost_ref_Perm_ptr_i32 [@inline:trivial] (self: t_Perm_ptr_i32) = inv_ref_Perm_ptr_i32 self
  
  meta "rewrite_def" predicate invariant_Ghost_ref_Perm_ptr_i32
  
  predicate inv_Ghost_ref_Perm_ptr_i32 [@inline:trivial] (_1: t_Perm_ptr_i32) = invariant_Ghost_ref_Perm_ptr_i32 _1
  
  meta "rewrite_def" predicate inv_Ghost_ref_Perm_ptr_i32
  
  let rec new_ref_Perm_ptr_i32 (x: t_Perm_ptr_i32) (return (x'0: t_Perm_ptr_i32)) =
    {[@stop_split] [@expl:new 'x' type invariant] inv_ref_Perm_ptr_i32 x}
    any
    [ return (result: t_Perm_ptr_i32) ->
    {[@stop_split] [@expl:new_ref_Perm_ptr_i32 ensures] ([@stop_split] [@expl:new result type invariant] inv_Ghost_ref_Perm_ptr_i32 result)
      /\ ([@stop_split] [@expl:new ensures] result = x)}
      (! return {result}) ]
  
  let rec as_ref_i32 (ptr'0: Opaque.ptr) (own: t_Perm_ptr_i32) (return (x: Int32.t)) =
    {[@stop_split] [@expl:as_ref_i32 requires] ([@stop_split] [@expl:as_ref 'own' type invariant] inv_Ghost_ref_Perm_ptr_i32 own)
    /\ ([@stop_split] [@expl:as_ref requires] ptr'0 = ward_ptr_i32 own)}
    any
    [ return (result: Int32.t) -> {[@stop_split] [@expl:as_ref ensures] result = val_ptr_i32 own} (! return {result}) ]
  
  meta "compute_max_steps" 1000000
  
  meta "select_lsinst" "all"
  
  let rec minimize (self: MutBorrow.t t_S) (return (x: ())) =
    {[@stop_split] [@expl:minimize requires] ([@stop_split] [@expl:minimize 'self' type invariant] inv_refmut_S self)
    /\ ([@stop_split] [@expl:minimize requires #0] Int32.to_int (val_ptr_i32 self.current.perm) = 1)
    /\ ([@stop_split] [@expl:minimize requires #1] ward_ptr_i32 self.current.perm = self.current.ptr)}
    (! bb0
    [ bb0 = s0
      [ s0 = s1 [ _ck -> (! {[@expl:type invariant] inv_refmut_S self} any) ]
      | s1 = -{resolve_refmut_S self}- s2
      | s2 = deref_Ghost_Box_Perm_ptr_i32_Global {self.current.perm} (fun (_x: t_Perm_ptr_i32) -> [ &_12 <- _x ] s3)
      | s3 = [ &_11 <- _12 ] s4
      | s4 = new_ref_Perm_ptr_i32 {_11} (fun (_x: t_Perm_ptr_i32) -> [ &_9 <- _x ] s5)
      | s5 = as_ref_i32 {self.current.ptr} {_9} (fun (_x: Int32.t) -> [ &r <- _x ] s6)
      | s6 = bb4 ]
    | bb4 = bb4
      [ bb4 = {[@expl:loop invariant] 0 <= Int32.to_int (val_ptr_i32 self.current.perm)} (! s0) [ s0 = bb4 ] ] ]
    [ & self: MutBorrow.t t_S = self
    | & r: Int32.t = Any.any_l ()
    | & _9: t_Perm_ptr_i32 = Any.any_l ()
    | & _11: t_Perm_ptr_i32 = Any.any_l ()
    | & _12: t_Perm_ptr_i32 = Any.any_l () ]) [ return (result: ()) -> (! return {result}) ]
end
